<!DOCTYPE html>
<html>
<head>
  <title>Mobile QR/Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      border: 2px solid #ccc;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #result {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center">Clock-In Scanner</h2>

  <div style="text-align:center">
    <button id="start-scan">Start Scan</button>
    <button id="toggle-mode">Toggle QR/Barcode Mode</button>
  </div>

  <div id="reader"></div>
  <p id="result">Scanner idle...</p>

  <script>
    let html5QrCode;
    let useBarcodeMode = false; // false = QR, true = Barcode
    let cameraId = null;

    // Replace this with your Apps Script URL
    const sheetURL = "https://script.google.com/macros/s/AKfycbwps9KCEVhUMSFt9BqvNkYgMhUAwmahXSgwMelTQa5etWFqlRUlLC0NiL2BK_JaFacmcg/exec";

    function sendToSheet(code) {
      fetch(sheetURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: code })
      });
      document.getElementById("result").innerText = "Scanned: " + code;
    }

    function onScanSuccess(decodedText) {
      sendToSheet(decodedText);
      html5QrCode.stop(); // stop scanning after successful scan
      document.getElementById("result").innerText = "Scanned: " + decodedText;
    }

    // Toggle QR / Barcode mode
    document.getElementById("toggle-mode").addEventListener("click", () => {
      useBarcodeMode = !useBarcodeMode;
      document.getElementById("result").innerText = "Mode: " + (useBarcodeMode ? "Barcode" : "QR");
    });

    // Start Scan button
    document.getElementById("start-scan").addEventListener("click", async () => {
      if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

      // Get cameras only once
      if (!cameraId) {
        try {
          const devices = await Html5Qrcode.getCameras();
          if (devices && devices.length) {
            cameraId = devices[devices.length - 1].id; // usually back camera
          } else {
            alert("No camera found.");
            return;
          }
        } catch (err) {
          alert("Camera error: " + err);
          return;
        }
      }

      const qrBoxSize = useBarcodeMode 
        ? { width: 400, height: 150 }  // wide rectangle for barcodes
        : { width: 250, height: 250 }; // square for QR codes

      html5QrCode.start(
        { deviceId: { exact: cameraId } },
        { fps: 10, qrbox: qrBoxSize },
        onScanSuccess,
        errorMessage => {
          // optional: console.log("Scan error:", errorMessage);
        }
      );
    });
  </script>
</body>
</html>
