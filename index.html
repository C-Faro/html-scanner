<!DOCTYPE html>
<html>
<head>
  <title>Clock In System</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>Clock In System</h1>

  <!-- Camera scanner -->
  <div id="reader" style="width:300px; height:300px; border:1px solid #ccc;"></div>
  <p id="result">Scan your card...</p>

  <!-- File upload option -->
  <h3>Or upload a QR code image:</h3>
  <input type="file" id="qr-input-file" accept="image/*">

  <script>
    // Replace with your Google Apps Script URL
    const sheetURL = "YOUR_GOOGLE_APPS_SCRIPT_WEBAPP_URL";

    // Track last scan time for each QR ID
    const lastScans = {};

    // Send scanned data to Google Sheet
    function sendToSheet(id) {
      fetch(sheetURL, {
        method: "POST",
        mode: "no-cors",   // avoids CORS errors
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ id: id })
      }).then(() => {
        console.log("✅ Sent to Google Sheet:", id);
      }).catch(err => {
        console.error("❌ Error sending to Google Sheet:", err);
      });
    }

    // Handle a successful scan
    function onScanSuccess(decodedText) {
      const now = Date.now();
      const lastTime = lastScans[decodedText] || 0;

      // Ignore if scanned within last 30 seconds
      if (now - lastTime < 30000) return;

      lastScans[decodedText] = now;
      document.getElementById("result").innerText = "Scanned: " + decodedText;
      sendToSheet(decodedText);
      console.log("Scanned and sent:", decodedText);
    }

    // --- Camera Scanner ---
    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length > 0) {
        const cameraId = cameras[0].id;
        html5QrCode.start(
          { deviceId: { exact: cameraId } },
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          (errorMessage) => {} // ignore scan errors
        );
      }
    }).catch(err => {
      console.error("Camera error:", err);
    });

    // --- File Upload Scanner ---
    document.getElementById("qr-input-file").addEventListener("change", e => {
      if (e.target.files.length == 0) return;
      const file = e.target.files[0];
      if (!file) return;

      const fileQrCode = new Html5Qrcode("reader"); // fresh instance for file scan
      fileQrCode.scanFile(file, true)
        .then(decodedText => {
          onScanSuccess(decodedText);
        })
        .catch(err => {
          document.getElementById("result").innerText = "Could not read QR from image.";
          console.error("File scan error:", err);
        });
    });
  </script>
</body>
</html>

